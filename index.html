<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üí≥ Sistema de Recargas</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- √çconos Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(135deg, #74ebd5 0%, #ACB6E5 100%);
      font-family: 'Segoe UI', sans-serif;
    }

    .container {
      max-width: 1050px;
    }

    .card-custom {
      border: none;
      border-radius: 15px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .card-custom:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 22px rgba(0,0,0,0.15);
    }

    .btn-primary {
      background: #4e73df;
      border: none;
    }
    .btn-primary:hover {
      background: #375ac4;
    }

    .btn-success {
      background: #1cc88a;
      border: none;
    }
    .btn-success:hover {
      background: #17a673;
    }

    .btn-danger {
      background: #e74a3b;
      border: none;
    }
    .btn-danger:hover {
      background: #c0392b;
    }

    .form-control:focus {
      border-color: #4e73df;
      box-shadow: 0 0 0 0.15rem rgba(78, 115, 223, 0.25);
    }
  </style>
</head>
<body>

  <div class="container my-5 p-4 bg-white rounded shadow-lg">
    <h1 class="text-center mb-4 text-primary">
      <i class="bi bi-lightning-charge-fill"></i> Sistema de Recargas
    </h1>

    <!-- Bot√≥n Excel -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0 text-success">
        Total Ganancias: $<span id="totalGanancias">0.00</span>
      </h4>
      <button id="descargarExcel" class="btn btn-primary shadow-sm">
        <i class="bi bi-file-earmark-excel-fill"></i> Descargar Excel
      </button>
    </div>

    <!-- Formulario -->
    <form id="recargaForm" class="row g-3 mb-4">
      <div class="col-md-4">
        <input type="text" name="nombre" id="inputNombre" class="form-control shadow-sm" placeholder="üë§ Nombre del cliente (opcional)">
      </div>
      <div class="col-md-4">
        <input type="text" name="numero" class="form-control shadow-sm" placeholder="üì± N√∫mero de tel√©fono" required>
      </div>
      <div class="col-md-4">
        <input type="number" name="monto" id="inputMonto" class="form-control shadow-sm" placeholder="üí∞ Monto" required>
      </div>
      <div class="col-md-4">
        <input type="text" name="usuario" class="form-control shadow-sm" placeholder="üôã Qui√©n hizo la recarga" required>
      </div>
      <div class="col-md-4">
        <input type="number" name="yapa" id="inputYapa" class="form-control shadow-sm" placeholder="üéÅ Yapa" readonly>
      </div>
      <div class="col-md-4">
        <input type="date" name="fechaRe" class="form-control shadow-sm" required>
      </div>
      <div class="col-12 text-center">
        <button type="submit" class="btn btn-success px-4 shadow-sm">
          <i class="bi bi-plus-circle"></i> Guardar Recarga
        </button>
      </div>
    </form>

    <!-- Contenedor Recargas -->
    <div id="recargasContainer" class="row g-4"></div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Librer√≠a para Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBOQUhvFfJz19gTpHrwXu4WmvowL2zYpC4",
      authDomain: "recargasnegocio-34355.firebaseapp.com",
      projectId: "recargasnegocio-34355",
      storageBucket: "recargasnegocio-34355.appspot.com",
      messagingSenderId: "481271413904",
      appId: "1:481271413904:web:134fe821b9ac61f475ec15"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const form = document.getElementById("recargaForm");
    const recargasContainer = document.getElementById("recargasContainer");
    const totalSpan = document.getElementById("totalGanancias");
    const inputMonto = document.getElementById("inputMonto");
    const inputYapa = document.getElementById("inputYapa");
    const inputNombre = document.getElementById("inputNombre");

    // Calcular Yapa autom√°ticamente (50% del monto, redondeo si impar)
    inputMonto.addEventListener("input", () => {
      const monto = parseFloat(inputMonto.value) || 0;
      let yapa = monto * 0.5;
      if (monto % 2 !== 0) {
        yapa = Math.floor(yapa);
      }
      inputYapa.value = yapa;
    });

    // Formatear fecha autom√°tica
    function formatearFecha(fecha) {
      if (!fecha || !fecha.toDate) return "";
      const f = fecha.toDate();
      return f.toLocaleString("es-BO", {
        day: "2-digit", month: "2-digit", year: "numeric",
        hour: "2-digit", minute: "2-digit"
      });
    }

    // Guardar recarga
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const nombre_cliente = form.nombre.value.trim() || "Anonimo";
      const numero_telefono = form.numero.value;
      const monto = parseFloat(form.monto.value);
      const usuario_recargador = form.usuario.value;
      const yapa = parseFloat(form.yapa.value) || 0;
      const fechaRe = form.fechaRe.value;

      try {
        await addDoc(collection(db, "recargas"), {
          nombre_cliente,
          numero_telefono,
          monto,
          usuario_recargador,
          yapa,
          fecha: serverTimestamp(),
          fechaRe
        });

        form.reset();
        inputYapa.value = "";

      } catch (e) {
        console.error("Error guardando recarga:", e);
        alert("‚ùå No se pudo guardar la recarga.");
      }
    });

    // Mostrar recargas m√°s recientes primero
    const colRef = collection(db, "recargas");
    const q = query(colRef, orderBy("fecha", "desc"));

    onSnapshot(q, (snapshot) => {
      recargasContainer.innerHTML = "";
      let total = 0;

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const fechaTexto = data.fecha ? formatearFecha(data.fecha) : "";

        const card = document.createElement("div");
        card.className = "col-md-4";
        card.innerHTML = `
          <div class="card card-custom shadow-sm h-100">
            <div class="card-body">
              <h5 class="card-title text-primary">
                <i class="bi bi-person-circle"></i> ${data.nombre_cliente}
              </h5>
              <p><strong>üì± Tel√©fono:</strong> ${data.numero_telefono}</p>
              <p><strong>üí∞ Monto:</strong> $${(data.monto || 0).toFixed(2)}</p>
              <p><strong>üéÅ Yapa:</strong> $${(data.yapa || 0).toFixed(2)}</p>
              <p><strong>üôã Recargador:</strong> ${data.usuario_recargador}</p>
              <p><strong>üìÖ Fecha Recarga:</strong> ${data.fechaRe || "No registrada"}</p>
              <p class="text-muted"><i class="bi bi-calendar-event"></i> ${fechaTexto}</p>
              <button class="btn btn-danger btn-sm">
                <i class="bi bi-trash"></i> Eliminar
              </button>
            </div>
          </div>
        `;
        recargasContainer.appendChild(card);

        total += (data.monto || 0);

        // Bot√≥n eliminar
        const btnEliminar = card.querySelector("button");
        btnEliminar.addEventListener("click", async () => {
          const password = prompt("Ingresa la contrase√±a para eliminar esta recarga:");
          if (password === "12345") {
            await deleteDoc(doc(db, "recargas", docSnap.id));
          } else {
            alert("‚ùå Contrase√±a incorrecta");
          }
        });
      });

      totalSpan.textContent = total.toFixed(2);
    });

    // Exportar a Excel
    document.getElementById("descargarExcel").addEventListener("click", async () => {
      try {
        const snapshot = await getDocs(q);
        const datos = [];

        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          datos.push({
            "Cliente": data.nombre_cliente || "",
            "Tel√©fono": data.numero_telefono || "",
            "Monto": data.monto?.toFixed(2) || "0.00",
            "Yapa": data.yapa?.toFixed(2) || "0.00",
            "Recargador": data.usuario_recargador || "",
            "Fecha Recarga": data.fechaRe || "",
            "Fecha Registro": data.fecha ? formatearFecha(data.fecha) : ""
          });
        });

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(datos);
        XLSX.utils.book_append_sheet(wb, ws, "Recargas");

        XLSX.writeFile(wb, "recargas_detalladas.xlsx");

      } catch (e) {
        console.error("Error exportando Excel:", e);
        alert("‚ùå No se pudo exportar a Excel.");
      }
    });
  </script>
</body>
</html>
