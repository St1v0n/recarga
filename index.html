<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sistema de Recargas</title>
  <link rel="stylesheet" href="css/estilos.css">

  <!-- Librer√≠a para exportar a Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBOQUhvFfJz19gTpHrwXu4WmvowL2zYpC4",
      authDomain: "recargasnegocio-34355.firebaseapp.com",
      projectId: "recargasnegocio-34355",
      storageBucket: "recargasnegocio-34355.appspot.com",
      messagingSenderId: "481271413904",
      appId: "1:481271413904:web:134fe821b9ac61f475ec15"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const form = document.getElementById("recargaForm");
    const recargasContainer = document.getElementById("recargasContainer");
    const totalSpan = document.getElementById("totalGanancias");
    const inputMonto = document.querySelector('input[name="monto"]');
    const inputYapa = document.querySelector('input[name="yapa"]');
    const inputNombre = document.querySelector('input[name="nombre"]');

    // Calcular Yapa autom√°ticamente (50% del monto)
    inputMonto.addEventListener("input", () => {
      const monto = parseFloat(inputMonto.value) || 0;
      inputYapa.value = ((monto * 0.5)-0.5).toFixed(2);
    });

    // Formatear fecha autom√°tica (serverTimestamp)
    function formatearFecha(fecha) {
      if (!fecha || !fecha.toDate) return "";
      const f = fecha.toDate();
      return f.toLocaleString("es-BO", {
        day: "2-digit", month: "2-digit", year: "numeric",
        hour: "2-digit", minute: "2-digit"
      });
    }

    // Guardar recarga
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const nombre_cliente = inputNombre.value.trim() || "Anonimo";
      const numero_telefono = form.numero.value;
      const monto = parseFloat(form.monto.value);
      const usuario_recargador = form.usuario.value;
      const yapa = parseFloat(form.yapa.value) || 0;
      const fechaRe = form.fechaRe.value;

      try {
        await addDoc(collection(db, "recargas"), {
          nombre_cliente,
          numero_telefono,
          monto,
          usuario_recargador,
          yapa,
          fecha: serverTimestamp(),
          fechaRe
        });

        form.reset();
        inputYapa.value = "";

      } catch (e) {
        console.error("Error guardando recarga:", e);
        alert("‚ùå No se pudo guardar la recarga.");
      }
    });

    // Mostrar recargas m√°s recientes primero
    const colRef = collection(db, "recargas");
    const q = query(colRef, orderBy("fecha", "desc"));

    onSnapshot(q, (snapshot) => {
      recargasContainer.innerHTML = "";
      let total = 0;

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const fechaTexto = data.fecha ? formatearFecha(data.fecha) : "";

        const card = document.createElement("div");
        card.className = "recarga-card";
        card.innerHTML = `
          <h3>${data.nombre_cliente}</h3>
          <p><strong>Tel√©fono:</strong> ${data.numero_telefono}</p>
          <p><strong>Monto:</strong> $${(data.monto || 0).toFixed(2)}</p>
          <p><strong>Yapa:</strong> $${(data.yapa || 0).toFixed(2)}</p>
          <p><strong>Recargador:</strong> ${data.usuario_recargador}</p>
          <p><strong>Fecha Recarga:</strong> ${data.fechaRe || "No registrada"}</p>
          <p class="fecha"><strong>Fecha Registro:</strong> ${fechaTexto}</p>
          <button class="eliminar-btn">Eliminar</button>
        `;
        recargasContainer.appendChild(card);

        // ‚úÖ Solo sumar el monto (NO yapa)
        total += (data.monto || 0);

        // Bot√≥n Eliminar
        const btnEliminar = card.querySelector(".eliminar-btn");
        btnEliminar.addEventListener("click", async () => {
          const password = prompt("Ingresa la contrase√±a para eliminar esta recarga:");
          if (password === "12345") {
            try {
              await deleteDoc(doc(db, "recargas", docSnap.id));
              alert("‚úÖ Recarga eliminada correctamente");
            } catch (e) {
              console.error("Error eliminando recarga:", e);
              alert("‚ùå No se pudo eliminar la recarga");
            }
          } else {
            alert("‚ùå Contrase√±a incorrecta");
          }
        });
      });

      totalSpan.textContent = total.toFixed(2);
    });

    // Exportar a Excel
    document.getElementById("descargarExcel").addEventListener("click", async () => {
      try {
        const snapshot = await getDocs(q);
        const datos = [];

        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          datos.push({
            "Cliente": data.nombre_cliente || "",
            "Tel√©fono": data.numero_telefono || "",
            "Monto": data.monto?.toFixed(2) || "0.00",
            "Yapa": data.yapa?.toFixed(2) || "0.00",
            "Recargador": data.usuario_recargador || "",
            "Fecha Recarga": data.fechaRe || "",
            "Fecha Registro": data.fecha ? formatearFecha(data.fecha) : ""
          });
        });

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(datos);
        XLSX.utils.book_append_sheet(wb, ws, "Recargas");

        XLSX.writeFile(wb, "recargas_detalladas.xlsx");

      } catch (e) {
        console.error("Error exportando Excel:", e);
        alert("‚ùå No se pudo exportar a Excel.");
      }
    });

  </script>
</head>
<body>
  <div class="container">
    <h1>Sistema de Recargas</h1>

    <!-- Formulario -->
    <form id="recargaForm" class="form-recarga">
      <input type="text" name="nombre" placeholder="Nombre del cliente (opcional)">
      <input type="text" name="numero" placeholder="N√∫mero de tel√©fono" required>
      <input type="number" name="monto" placeholder="Monto" required>
      <input type="text" name="usuario" placeholder="Qui√©n hizo la recarga" required>
      <input type="number" name="yapa" placeholder="Yapa" step="0.01" readonly>
      <input type="date" name="fechaRe" required>
      <button type="submit">Guardar Recarga</button>
    </form>

    <!-- Historial -->
    <h2>Historial de Recargas</h2>
    <div id="recargasContainer" class="recargas-container"></div>

    <!-- Total y bot√≥n de Excel -->
    <h3>Total Ganancias: <span id="totalGanancias">0.00</span></h3>
    <button id="descargarExcel">üìÑ Descargar Excel</button>
  </div>
</body>
</html>